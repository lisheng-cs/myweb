import{q as m,O as g,d as Oe,r as _,m as k,o as xe,n as Le,c as h,a as s,w as a,b as c,f as p,i as f,h as Be,g as b,j as Me,k as S,t as P,F as x,l as L,u as C,p as B,s as Ee,B as w,E as M,v as se,_ as De}from"./index-h4lH79Q9.js";import{F as Re}from"./FileControllerService-DqaFuhN1.js";import{a as j}from"./TimeParse-Dn2ZSm0v.js";class W{static addCommentUsingPost(l){return m(g,{method:"POST",url:"/comments/add",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static deleteCommentUsingPost(l){return m(g,{method:"POST",url:"/comments/delete",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static getByIdUsingPost1(l){return m(g,{method:"POST",url:"/comments/getby_id",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static listPostCommentReplyUsingPost(l){return m(g,{method:"POST",url:"/comments/list_reply",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static listPostCommentTopUsingPost(l){return m(g,{method:"POST",url:"/comments/list_top",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}}class ${static addPostUsingPost(l){return m(g,{method:"POST",url:"/post/add",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static deletePostUsingPost(l){return m(g,{method:"POST",url:"/post/delete",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static editPostUsingPost(l){return m(g,{method:"POST",url:"/post/edit",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static getPostVoByIdUsingGet(l){return m(g,{method:"GET",url:"/post/get/vo",query:{id:l},errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static listPostByPageUsingPost(l){return m(g,{method:"POST",url:"/post/list/page",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static listPostVoByPageUsingPost(l){return m(g,{method:"POST",url:"/post/list/page/vo",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static listMyFavouritePostsUsingPost(l){return m(g,{method:"POST",url:"/post/my/favour/list/page/vo",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static listMyPostVoByPageUsingPost(l){return m(g,{method:"POST",url:"/post/my/list/page/vo",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static listMyThumbPostsUsingPost(l){return m(g,{method:"POST",url:"/post/my/thumb/list/page/vo",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static searchPostVoByPageUsingPost(l){return m(g,{method:"POST",url:"/post/search/page/vo",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static updatePostUsingPost(l){return m(g,{method:"POST",url:"/post/update",body:l,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}}const je={class:"post-management"},$e={class:"content-preview"},qe={class:"image-container"},Ae={class:"pagination-container"},Ge={class:"comment-header"},He={class:"comment-user"},Je={class:"comment-time"},Ke={class:"comment-content"},Qe={class:"comment-actions"},We={key:0,class:"replies"},Xe={class:"reply-user"},Ye={class:"reply-content-text"},Ze={class:"reply-time"},Ie={key:0,class:"load-more-parent"},et=Oe({__name:"PostList",setup(X){const l=_([]),q=_(!1),v=k({current:1,pageSize:10,total:0}),E=k({title:""}),T=_(!1),D=_(!1),i=k({title:"",content:"",tagList:[],imageList:[]}),A=_(),ae=k({title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}]}),le=_([]),G=_([]),V=_([]),H=_(1),ne=_(5),J=_(!0),y=k({}),N=k({}),ie=_(5),O=k({}),z=k({});xe(F);async function F(){q.value=!0;try{const t={...E,current:v.current,pageSize:v.pageSize},e=await $.listPostVoByPageUsingPost(t);e.code===0&&e.data&&(l.value=e.data.records||[],v.total=Number(e.data.total))}finally{q.value=!1}}function Y(t,e){var n,r;D.value=t==="edit",(n=A.value)==null||n.resetFields(),Object.assign(i,{id:void 0,title:"",content:"",tagList:[],imageList:[]}),G.value=[],Z(),t==="edit"&&e&&(Object.assign(i,e),G.value=((r=e.imageList)==null?void 0:r.map(d=>({name:d.split("/").pop(),url:w+d})))||[],K(e.id)),T.value=!0}function Z(){V.value=[],H.value=1,J.value=!0,Object.keys(y).forEach(t=>delete y[+t]),Object.keys(N).forEach(t=>delete N[+t]),Object.keys(O).forEach(t=>delete O[+t]),Object.keys(z).forEach(t=>delete z[+t])}async function K(t){const e={postId:t,current:H.value,pageSize:ne.value},n=await W.listPostCommentTopUsingPost(e);n.code===0&&n.data&&(V.value.push(...n.data.records||[]),J.value=V.value.length<(n.data.total||0))}function re(){H.value++,i.id&&K(i.id)}async function de(t){z[t]=!z[t],z[t]&&!y[t]&&(N[t]=1,await I(t))}async function I(t){const e=N[t],n={parentId:t,current:e,pageSize:ie.value},r=await W.listPostCommentReplyUsingPost(n);r.code===0&&r.data&&(y[t]=(y[t]||[]).concat(r.data.records||[]),O[t]=y[t].length<(r.data.total||0))}function ue(t){N[t]++,I(t)}async function ee(t){if(t)try{if(await se.confirm("确认删除该评论吗？","提示",{type:"warning"}),await W.deleteCommentUsingPost({id:t}),M.success("删除成功"),V.value.findIndex(n=>n.id===t)>=0)Z(),i.id&&K(i.id);else for(const n in y){const r=y[n].findIndex(d=>d.id===t);if(r>=0){y[n].splice(r,1),y[n].length===0&&!O[+n]&&(z[+n]=!1);break}}}catch{}}async function ce(t){try{const e=await Re.uploadFileUsingPost(t.raw,"user_post");e.code===0&&e.data&&i.imageList.push(e.data)}catch{M.error("图片上传失败")}}function pe(t){const e=t.url.replace(w,"");i.imageList=i.imageList.filter(n=>n!==e)}async function me(){try{await A.value.validate();const t={...i,images:i.imageList,tags:i.tagList};D.value?await $.updatePostUsingPost(t):await $.addPostUsingPost(t),M.success("操作成功"),T.value=!1,F()}catch{M.error("操作失败")}}async function ge(t){if(t)try{await se.confirm("确认删除该帖子吗？","提示",{type:"warning"}),await $.deletePostUsingPost({id:t}),M.success("删除成功"),F()}catch{}}function fe(t){v.current=t,F()}function _e(t){v.pageSize=t,v.current=1,F()}function ve(){E.title="",F()}function ye(t){return t?t.length>50?t.slice(0,50)+"...":t:""}const be=Le(()=>D.value?"编辑帖子":"新增帖子");return(t,e)=>{const n=c("el-input"),r=c("el-form-item"),d=c("el-button"),te=c("el-form"),Q=c("el-card"),U=c("el-table-column"),Pe=c("el-tooltip"),he=c("el-image"),Ue=c("el-tag"),Ce=c("el-table"),ze=c("el-pagination"),ke=c("el-option"),Fe=c("el-select"),Se=c("el-icon"),we=c("el-upload"),oe=c("el-avatar"),Te=c("el-dialog"),Ve=Me("loading");return p(),h("div",je,[s(Q,{class:"search-card"},{default:a(()=>[s(te,{inline:!0},{default:a(()=>[s(r,{label:"帖子标题"},{default:a(()=>[s(n,{modelValue:E.title,"onUpdate:modelValue":e[0]||(e[0]=o=>E.title=o),placeholder:"请输入标题",clearable:""},null,8,["modelValue"])]),_:1}),s(r,null,{default:a(()=>[s(d,{type:"primary",onClick:F},{default:a(()=>e[9]||(e[9]=[f("搜索")])),_:1}),s(d,{onClick:ve},{default:a(()=>e[10]||(e[10]=[f("重置")])),_:1}),s(d,{type:"success",onClick:e[1]||(e[1]=o=>Y("add"))},{default:a(()=>e[11]||(e[11]=[f("新增帖子")])),_:1})]),_:1})]),_:1})]),_:1}),s(Q,{class:"table-card"},{default:a(()=>[Be((p(),S(Ce,{data:l.value,border:"",style:{width:"100%"},"max-height":"680"},{default:a(()=>[s(U,{prop:"id",label:"ID",width:"80"}),s(U,{prop:"title",label:"标题",width:"180"}),s(U,{label:"内容","min-width":"200"},{default:a(({row:o})=>[s(Pe,{effect:"dark",content:o.content,placement:"top"},{default:a(()=>[b("div",$e,P(ye(o.content)),1)]),_:2},1032,["content"])]),_:1}),s(U,{label:"图片",width:"180"},{default:a(({row:o})=>[b("div",qe,[(p(!0),h(x,null,L(o.imageList,(u,R)=>(p(),S(he,{key:R,src:C(w)+u,fit:"cover",class:"thumb-image","preview-src-list":o.imageList.map(Ne=>C(w)+Ne),"preview-teleported":!0},null,8,["src","preview-src-list"]))),128))])]),_:1}),s(U,{prop:"tagList",label:"标签",width:"180"},{default:a(({row:o})=>[(p(!0),h(x,null,L(o.tagList,(u,R)=>(p(),S(Ue,{key:R,type:"info",class:"tag"},{default:a(()=>[f(P(u),1)]),_:2},1024))),128))]),_:1}),s(U,{prop:"user.userName",label:"作者",width:"120"}),s(U,{label:"创建时间",width:"160"},{default:a(({row:o})=>[f(P(C(j)(o.createTime)),1)]),_:1}),s(U,{label:"更新时间",width:"160"},{default:a(({row:o})=>[f(P(C(j)(o.updateTime)),1)]),_:1}),s(U,{label:"操作",width:"150",fixed:"right"},{default:a(({row:o})=>[s(d,{size:"small",onClick:u=>Y("edit",o)},{default:a(()=>e[12]||(e[12]=[f("编辑")])),_:2},1032,["onClick"]),s(d,{size:"small",type:"danger",onClick:u=>ge(o.id)},{default:a(()=>e[13]||(e[13]=[f("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ve,q.value]]),b("div",Ae,[s(ze,{"current-page":v.current,"onUpdate:currentPage":e[2]||(e[2]=o=>v.current=o),"page-size":v.pageSize,"onUpdate:pageSize":e[3]||(e[3]=o=>v.pageSize=o),"page-sizes":[5,10,20,30],total:v.total,background:"",layout:"total, sizes, prev, pager, next, jumper",onSizeChange:_e,onCurrentChange:fe},null,8,["current-page","page-size","total"])])]),_:1}),s(Te,{modelValue:T.value,"onUpdate:modelValue":e[8]||(e[8]=o=>T.value=o),title:be.value,width:"800px"},{footer:a(()=>[s(d,{onClick:e[7]||(e[7]=o=>T.value=!1)},{default:a(()=>e[18]||(e[18]=[f("取消")])),_:1}),s(d,{type:"primary",onClick:me},{default:a(()=>e[19]||(e[19]=[f("确认")])),_:1})]),default:a(()=>[s(te,{model:i,rules:ae,ref_key:"formRef",ref:A,"label-width":"80px"},{default:a(()=>[s(r,{label:"标题",prop:"title"},{default:a(()=>[s(n,{modelValue:i.title,"onUpdate:modelValue":e[4]||(e[4]=o=>i.title=o)},null,8,["modelValue"])]),_:1}),s(r,{label:"内容",prop:"content"},{default:a(()=>[s(n,{modelValue:i.content,"onUpdate:modelValue":e[5]||(e[5]=o=>i.content=o),type:"textarea",rows:6,placeholder:"请输入帖子内容"},null,8,["modelValue"])]),_:1}),s(r,{label:"标签"},{default:a(()=>[s(Fe,{modelValue:i.tagList,"onUpdate:modelValue":e[6]||(e[6]=o=>i.tagList=o),multiple:"",filterable:"","allow-create":"",placeholder:"请输入或选择标签",style:{width:"100%"}},{default:a(()=>[(p(!0),h(x,null,L(le.value,(o,u)=>(p(),S(ke,{key:u,label:o,value:o},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),s(r,{label:"图片"},{default:a(()=>[s(we,{action:"#","list-type":"picture-card","auto-upload":!1,"file-list":G.value,"on-change":ce,"on-remove":pe,multiple:""},{default:a(()=>[s(Se,null,{default:a(()=>[s(C(Ee))]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model","rules"]),D.value?(p(),S(Q,{key:0,class:"comment-section",header:"评论管理"},{default:a(()=>[(p(!0),h(x,null,L(V.value,o=>(p(),h("div",{key:o.id,class:"parent-comment"},[b("div",Ge,[s(oe,{src:C(w)+o.userAvatar,size:"small"},null,8,["src"]),b("span",He,P(o.userName),1),b("span",Je,P(C(j)(o.createTime)),1),s(d,{type:"text",size:"small",onClick:u=>ee(o.id)},{default:a(()=>e[14]||(e[14]=[f("删除")])),_:2},1032,["onClick"])]),b("div",Ke,P(o.content),1),b("div",Qe,[o.hasReply?(p(),S(d,{key:0,type:"text",size:"small",onClick:u=>de(o.id)},{default:a(()=>[f(P(z[o.id]?"收起子评论":"查看子评论"),1)]),_:2},1032,["onClick"])):B("",!0)]),z[o.id]?(p(),h("div",We,[(p(!0),h(x,null,L(y[o.id],u=>(p(),h("div",{class:"reply-item",key:u.id},[s(oe,{src:C(w)+u.replyUserAvatar,size:"small"},null,8,["src"]),b("span",Xe,P(u.replyUserName)+"：",1),b("span",Ye,P(u.content),1),b("span",Ze,P(C(j)(u.createTime)),1),s(d,{type:"text",size:"mini",onClick:R=>ee(u.id)},{default:a(()=>e[15]||(e[15]=[f("删除")])),_:2},1032,["onClick"])]))),128)),O[o.id]?(p(),S(d,{key:0,type:"text",size:"small",onClick:u=>ue(o.id)},{default:a(()=>e[16]||(e[16]=[f("加载更多子评论")])),_:2},1032,["onClick"])):B("",!0)])):B("",!0)]))),128)),J.value?(p(),h("div",Ie,[s(d,{type:"text",size:"small",onClick:re},{default:a(()=>e[17]||(e[17]=[f("加载更多评论")])),_:1})])):B("",!0)]),_:1})):B("",!0)]),_:1},8,["modelValue","title"])])}}}),at=De(et,[["__scopeId","data-v-d616d961"]]);export{at as default};
