import{q as L,O as $,d as le,r as g,x as ge,n as te,c as C,f as c,a as t,b as p,w as r,k as w,p as W,F as O,l as E,_ as ae,m as K,o as Ue,E as F,i as x,h as ke,g as we,j as Ce,u as I,B as j,t as Q,s as de,v as Se}from"./index-h4lH79Q9.js";import{A as ce}from"./ActorControllerService-B2yOgfWp.js";import{D as pe}from"./DirectorControllerService-CX4ArWj3.js";import{F as me}from"./FileControllerService-DqaFuhN1.js";import{f as Pe}from"./TimeParse-Dn2ZSm0v.js";class H{static addMovieUsingPost(V){return L($,{method:"POST",url:"/movie/add",body:V,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static deleteMovieUsingPost(V){return L($,{method:"POST",url:"/movie/delete",body:V,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static getListGenresUsingGet(){return L($,{method:"GET",url:"/movie/genres",errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static getByIdUsingPost(V){return L($,{method:"POST",url:"/movie/getById",body:V,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static searchMovieByConditionalUsingPost(V){return L($,{method:"POST",url:"/movie/search",body:V,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}static updateMovieUsingPost(V){return L($,{method:"POST",url:"/movie/update",body:V,errors:{401:"Unauthorized",403:"Forbidden",404:"Not Found"}})}}const xe={class:"actor-selector"},ze={key:1,style:{"text-align":"center",color:"#999",padding:"10px 0"}},Z=10,Ie=le({__name:"ActorSelector",props:{modelValue:{type:Array,default:()=>[]}},emits:["update:modelValue"],setup(Y,{emit:V}){const M=Y;console.log(M.modelValue);const _=V,v=g(!1),b=g(1),i=g(0),S=g(""),h=g([]),U=g([]),f=g([]);async function D(a){var u;if(!a||a.length===0)return;const n=new Set(f.value.map(s=>s.id)),y=a.filter(s=>!n.has(s));if(y.length!==0)try{const s=await ce.listActorByPageUsingPost({current:1,pageSize:y.length,idList:y});if(s.code===0&&((u=s.data)!=null&&u.records)){const o=new Map(f.value.map(e=>[e.id,e]));s.data.records.forEach(e=>{e&&e.id!=null&&o.set(e.id,e)}),f.value=Array.from(o.values())}}catch(s){console.error("根据 ID 获取演员信息失败:",s)}finally{}}ge(()=>M.modelValue,async a=>{let n=[],y=!1;if(Array.isArray(a)&&a.length>0){const u=a[0];if(typeof u=="object"&&u!==null&&u.hasOwnProperty("id")){y=!0,n=a.map(o=>o==null?void 0:o.id).filter(o=>o!=null);const s=new Map(f.value.map(o=>[o.id,o]));a.forEach(o=>{o&&o.id!=null&&s.set(o.id,o)}),f.value=Array.from(s.values())}else(typeof u=="number"||typeof u=="string")&&(n=a.map(s=>Number(s)).filter(s=>!isNaN(s)&&s!=null))}h.value=n,!y&&n.length>0&&await D(n),f.value=f.value.filter(u=>h.value.includes(u.id))},{immediate:!0,deep:!0});const N=te(()=>{const a=new Map;return f.value.forEach(n=>{n&&n.id!=null&&a.set(n.id,n)}),U.value.forEach(n=>{n&&n.id!=null&&a.set(n.id,n)}),Array.from(a.values())}),k=async(a=S.value)=>{v.value=!0;try{const n=await ce.listActorByPageUsingPost({current:b.value,pageSize:Z,userName:a});n.code===0&&n.data?(U.value=n.data.records||[],i.value=parseInt(n.data.total)||0):(U.value=[],i.value=0)}catch(n){console.error("搜索演员列表失败:",n),U.value=[],i.value=0}finally{v.value=!1}},A=a=>{S.value=a,b.value=1,k(a)},q=a=>{b.value=a,k()},T=a=>{a&&U.value.length===0&&(b.value=1,S.value="",k())},G=a=>{h.value=a||[],_("update:modelValue",h.value),f.value=f.value.filter(n=>h.value.includes(n.id)),D(h.value)};return(a,n)=>{const y=p("el-option"),u=p("el-pagination"),s=p("el-select");return c(),C("div",xe,[t(s,{modelValue:h.value,"onUpdate:modelValue":n[0]||(n[0]=o=>h.value=o),multiple:"",filterable:"",remote:"","reserve-keyword":"",placeholder:"搜索并选择演员","remote-method":A,loading:v.value,onVisibleChange:T,style:{width:"100%"},onChange:G},{default:r(()=>[(c(!0),C(O,null,E(N.value,o=>(c(),w(y,{key:o.id,label:o.userName,value:o.id},null,8,["label","value"]))),128)),i.value>Z?(c(),w(u,{key:0,small:"",layout:"prev, pager, next",total:i.value,"page-size":Z,"current-page":b.value,onCurrentChange:q,style:{padding:"5px 15px"}},null,8,["total","current-page"])):W("",!0),!v.value&&N.value.length===0&&U.value.length===0?(c(),C("div",ze," 无匹配演员 ")):W("",!0)]),_:1},8,["modelValue","loading"])])}}}),Me=ae(Ie,[["__scopeId","data-v-d4a580c4"]]),De={class:"director-selector"},Ne={key:1,style:{"text-align":"center",color:"#999",padding:"10px 0"}},ee=10,Ae=le({__name:"DirectorSelector",props:{modelValue:{type:[Number,Object],default:void 0}},emits:["update:modelValue"],setup(Y,{emit:V}){const M=Y,_=V,v=g(!1),b=g(1),i=g(0),S=g(""),h=g(void 0),U=g([]),f=g([]);async function D(a){var y;if(!a.length)return;const n=a.filter(u=>!f.value.find(s=>s.id===u));if(n.length)try{const u=await pe.listDirectorByPageUsingPost({current:1,pageSize:n.length,idList:n});if(u.code===0&&((y=u.data)!=null&&y.records)){const s=new Map(f.value.map(o=>[o.id,o]));u.data.records.forEach(o=>{o.id!=null&&s.set(o.id,o)}),f.value=Array.from(s.values())}}catch(u){console.error("根据 ID 获取导演信息失败",u)}}ge(()=>M.modelValue,async a=>{let n;if(typeof a=="object"&&(a==null?void 0:a.id)!=null){n=a.id;const y=new Map(f.value.map(u=>[u.id,u]));y.set(a.id,a),f.value=Array.from(y.values())}else typeof a=="number"&&(n=a,await D([a]));h.value=n},{immediate:!0});const N=te(()=>{const a=new Map;return f.value.forEach(n=>{n.id!=null&&a.set(n.id,n)}),U.value.forEach(n=>{n.id!=null&&a.set(n.id,n)}),Array.from(a.values())});async function k(a){S.value=a,b.value=1,await A()}async function A(){v.value=!0;try{const a=await pe.listDirectorByPageUsingPost({current:b.value,pageSize:ee,userName:S.value});a.code===0&&a.data?(U.value=a.data.records||[],i.value=parseInt(a.data.total)||0):(U.value=[],i.value=0)}catch(a){console.error("搜索导演失败",a),U.value=[],i.value=0}finally{v.value=!1}}function q(a){b.value=a,A()}function T(a){a&&(b.value=1,S.value="",A())}async function G(a){h.value=a,_("update:modelValue",a),await D(a!=null?[a]:[])}return(a,n)=>{const y=p("el-option"),u=p("el-pagination"),s=p("el-select");return c(),C("div",De,[t(s,{modelValue:h.value,"onUpdate:modelValue":n[0]||(n[0]=o=>h.value=o),filterable:"",remote:"","reserve-keyword":"",placeholder:"搜索并选择导演","remote-method":k,loading:v.value,onVisibleChange:T,style:{width:"100%"},onChange:G},{default:r(()=>[(c(!0),C(O,null,E(N.value,o=>(c(),w(y,{key:o.id,label:o.userName,value:o.id},null,8,["label","value"]))),128)),i.value>ee?(c(),w(u,{key:0,small:"",layout:"prev, pager, next",total:i.value,"page-size":ee,"current-page":b.value,onCurrentChange:q,style:{padding:"5px 15px"}},null,8,["total","current-page"])):W("",!0),!v.value&&N.value.length===0&&U.value.length===0?(c(),C("div",Ne," 无匹配导演 ")):W("",!0)]),_:1},8,["modelValue","loading"])])}}}),Be=ae(Ae,[["__scopeId","data-v-efbc4a8b"]]),Fe={class:"movie-management"},Oe={class:"pagination-container"},Ee=le({__name:"MovieList",setup(Y){const V=g([]),M=g(!1),_=K({title:"",actor:[],director:"",genres:[],original_country:"",year:"",current:1,pageSize:10}),v=K({current:1,pageSize:10,total:0}),b=g(!1),i=K({title:"",original_title:"",release_date:"",genres:[],poster:"",backdrop:"",runtime:0,actors:[],director:void 0,imdbId:"",tmdbId:"",origin_country:"",original_language:"",overview:""}),S=g(),h=g(!1),U=g([]),f=g([]);g([]);const D=K({title:[{required:!0,message:"请输入中文名称",trigger:"blur"}],original_title:[{required:!0,message:"请输入原片名",trigger:"blur"}],release_date:[{required:!0,message:"请选择上映日期",trigger:"change"}],genres:[{required:!0,message:"请至少选择一个类型",trigger:"change"}],director:[{required:!0,message:"请选择导演",trigger:"change"}],runtime:[{required:!0,message:"请输入时长",trigger:"blur"}],poster:[{required:!0,message:"请输入海报地址",trigger:"blur"}],backdrop:[{required:!0,message:"请输入背景图地址",trigger:"blur"}]}),N=te(()=>h.value?"编辑电影":"新增电影"),k=async()=>{try{M.value=!0;const o={..._,current:v.current,pageSize:v.pageSize},e=await H.searchMovieByConditionalUsingPost(o);e.code===0&&e.data&&(V.value=e.data.records||[],v.total=parseInt(e.data.total)||0)}catch{F.error("数据加载失败")}finally{M.value=!1}},A=async()=>{try{const o=await H.getListGenresUsingGet();o.code===0&&(U.value=o.data||[])}catch{F.error("基础数据加载失败")}},q=(o,e)=>{var d,m;h.value=o==="edit",o==="edit"&&e?Object.assign(i,{...e,genres:(d=e.genres)==null?void 0:d.map(R=>R.id),actors:e.actors,director:e.director}):(m=S.value)==null||m.resetFields(),b.value=!0},T=async()=>{var o,e;try{await S.value.validate();const d={...i,runtime:Number(i.runtime),director:Number(i.director),genres:(o=i.genres)==null?void 0:o.map(Number),actors:(e=i.actors)==null?void 0:e.map(Number)};h.value?await H.updateMovieUsingPost(d):await H.addMovieUsingPost(d),F.success("操作成功"),b.value=!1,k()}catch(d){console.error("操作失败:",d),F.error("操作失败")}},G=async o=>{try{await Se.confirm("确认删除该电影吗？","提示",{type:"warning"}),await H.deleteMovieUsingPost({id:o}),F.success("删除成功"),k()}catch{}},a=o=>{v.current=o,k()},n=o=>{v.pageSize=o,v.current=1,k()},y=()=>{Object.assign(_,{title:"",actor:[],director:"",genres:[],original_country:"",year:"",current:1,pageSize:10}),k()};Ue(()=>{k(),A()});const u=async o=>{try{const e=o.file,d=await me.uploadFileUsingPost(e,"movie_poster");d.code===0&&d.data&&(i.poster=d.data)}catch{F.error("海报上传失败")}},s=async o=>{try{const e=o.file,d=await me.uploadFileUsingPost(e,"movie_backdrop");d.code===0&&d.data&&(i.backdrop=d.data)}catch{F.error("背景图上传失败")}};return(o,e)=>{const d=p("el-input"),m=p("el-form-item"),R=p("el-option"),X=p("el-select"),oe=p("el-date-picker"),B=p("el-button"),re=p("el-form"),ne=p("el-card"),P=p("el-table-column"),J=p("el-image"),ve=p("el-tag"),fe=p("el-table"),_e=p("el-pagination"),ie=p("el-icon"),se=p("el-upload"),ue=p("el-col"),ye=p("el-input-number"),be=p("el-row"),he=p("el-dialog"),Ve=Ce("loading");return c(),C("div",Fe,[t(ne,{class:"search-card"},{default:r(()=>[t(re,{inline:!0},{default:r(()=>[t(m,{label:"电影名称"},{default:r(()=>[t(d,{modelValue:_.title,"onUpdate:modelValue":e[0]||(e[0]=l=>_.title=l),placeholder:"请输入名称",clearable:""},null,8,["modelValue"])]),_:1}),t(m,{label:"演员"},{default:r(()=>[t(X,{modelValue:_.actor,"onUpdate:modelValue":e[1]||(e[1]=l=>_.actor=l),multiple:"",filterable:"",placeholder:"选择演员"},{default:r(()=>[(c(!0),C(O,null,E(f.value,l=>(c(),w(R,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(m,{label:"导演"},{default:r(()=>[t(d,{modelValue:_.director,"onUpdate:modelValue":e[2]||(e[2]=l=>_.director=l),placeholder:"输入导演姓名",clearable:""},null,8,["modelValue"])]),_:1}),t(m,{label:"类型"},{default:r(()=>[t(X,{modelValue:_.genres,"onUpdate:modelValue":e[3]||(e[3]=l=>_.genres=l),multiple:"",placeholder:"选择类型"},{default:r(()=>[(c(!0),C(O,null,E(U.value,l=>(c(),w(R,{key:l.id,label:l.genreName,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(m,{label:"原产国"},{default:r(()=>[t(d,{modelValue:_.original_country,"onUpdate:modelValue":e[4]||(e[4]=l=>_.original_country=l),placeholder:"输入国家",clearable:""},null,8,["modelValue"])]),_:1}),t(m,{label:"上映年份"},{default:r(()=>[t(oe,{modelValue:_.year,"onUpdate:modelValue":e[5]||(e[5]=l=>_.year=l),type:"year","value-format":"YYYY",placeholder:"选择年份"},null,8,["modelValue"])]),_:1}),t(m,null,{default:r(()=>[t(B,{type:"primary",onClick:k},{default:r(()=>e[23]||(e[23]=[x("搜索")])),_:1}),t(B,{onClick:y},{default:r(()=>e[24]||(e[24]=[x("重置")])),_:1}),t(B,{type:"success",onClick:e[6]||(e[6]=l=>q("add"))},{default:r(()=>e[25]||(e[25]=[x("新增电影")])),_:1})]),_:1})]),_:1})]),_:1}),t(ne,{class:"table-card"},{default:r(()=>[ke((c(),w(fe,{data:V.value,border:"",style:{width:"100%"}},{default:r(()=>[t(P,{prop:"id",label:"ID",width:"80"}),t(P,{prop:"title",label:"中文名",width:"150"}),t(P,{prop:"original_title",label:"原名",width:"180"}),t(P,{label:"海报",width:"120"},{default:r(({row:l})=>[t(J,{src:I(j)+l.poster,fit:"cover",style:{width:"80px",height:"120px"},"preview-src-list":[I(j)+l.poster],"preview-teleported":!0},null,8,["src","preview-src-list"])]),_:1}),t(P,{label:"背景图",width:"120"},{default:r(({row:l})=>[t(J,{src:I(j)+l.backdrop,fit:"cover",style:{width:"120px",height:"80px"},"preview-src-list":[I(j)+l.backdrop],"preview-teleported":!0},null,8,["src","preview-src-list"])]),_:1}),t(P,{prop:"row.release_date",label:"上映日期",width:"120"},{default:r(({row:l})=>[x(Q(I(Pe)(l.release_date)),1)]),_:1}),t(P,{label:"类型",width:"200"},{default:r(({row:l})=>[(c(!0),C(O,null,E(l.genres,z=>(c(),w(ve,{key:z.id,type:"info",class:"tag"},{default:r(()=>[x(Q(z.genreName),1)]),_:2},1024))),128))]),_:1}),t(P,{label:"演员",width:"200"},{default:r(({row:l})=>[(c(!0),C(O,null,E(l.actors,z=>(c(),C("div",{key:z.id},Q(z.userName),1))),128))]),_:1}),t(P,{label:"导演",width:"150"},{default:r(({row:l})=>{var z;return[x(Q((z=l.director)==null?void 0:z.userName),1)]}),_:1}),t(P,{prop:"rating",label:"平均评分",width:"100"},{default:r(({row:l})=>[x(Q(l.vote_count==0?0:(l.vote_sum/l.vote_count).toFixed(1)),1)]),_:1}),t(P,{label:"操作",width:"180",fixed:"right"},{default:r(({row:l})=>[t(B,{size:"small",onClick:z=>q("edit",l)},{default:r(()=>e[26]||(e[26]=[x("编辑")])),_:2},1032,["onClick"]),t(B,{size:"small",type:"danger",onClick:z=>G(l.id)},{default:r(()=>e[27]||(e[27]=[x("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ve,M.value]]),we("div",Oe,[t(_e,{"current-page":v.current,"onUpdate:currentPage":e[7]||(e[7]=l=>v.current=l),"page-size":v.pageSize,"onUpdate:pageSize":e[8]||(e[8]=l=>v.pageSize=l),"page-sizes":[5,10,20,30,40],total:v.total,background:"",layout:"total, sizes, prev, pager, next, jumper",onSizeChange:n,onCurrentChange:a},null,8,["current-page","page-size","total"])])]),_:1}),t(he,{modelValue:b.value,"onUpdate:modelValue":e[22]||(e[22]=l=>b.value=l),title:N.value,width:"800px"},{footer:r(()=>[t(B,{onClick:e[21]||(e[21]=l=>b.value=!1)},{default:r(()=>e[28]||(e[28]=[x("取消")])),_:1}),t(B,{type:"primary",onClick:T},{default:r(()=>e[29]||(e[29]=[x("确认")])),_:1})]),default:r(()=>[t(re,{model:i,rules:D,ref_key:"formRef",ref:S,"label-width":"120px"},{default:r(()=>[t(be,{gutter:20},{default:r(()=>[t(ue,{span:12},{default:r(()=>[t(m,{label:"海报",prop:"poster"},{default:r(()=>[t(se,{class:"image-uploader","show-file-list":!1,"auto-upload":!0,"http-request":u},{default:r(()=>[i.poster?(c(),w(J,{key:0,src:I(j)+i.poster,fit:"cover",class:"upload-image"},null,8,["src"])):(c(),w(ie,{key:1,class:"upload-icon"},{default:r(()=>[t(I(de))]),_:1}))]),_:1})]),_:1}),t(m,{label:"背景图",prop:"backdrop"},{default:r(()=>[t(se,{class:"image-uploader-back","show-file-list":!1,"auto-upload":!0,"http-request":s},{default:r(()=>[i.backdrop?(c(),w(J,{key:0,src:I(j)+i.backdrop,fit:"cover",class:"upload-image"},null,8,["src"])):(c(),w(ie,{key:1,class:"upload-icon"},{default:r(()=>[t(I(de))]),_:1}))]),_:1})]),_:1}),t(m,{label:"演员",prop:"actors"},{default:r(()=>[t(Me,{modelValue:i.actors,"onUpdate:modelValue":e[9]||(e[9]=l=>i.actors=l)},null,8,["modelValue"])]),_:1}),t(m,{label:"导演",prop:"director"},{default:r(()=>[t(Be,{modelValue:i.director,"onUpdate:modelValue":e[10]||(e[10]=l=>i.director=l)},null,8,["modelValue"])]),_:1}),t(m,{label:"中文名称",prop:"title"},{default:r(()=>[t(d,{modelValue:i.title,"onUpdate:modelValue":e[11]||(e[11]=l=>i.title=l)},null,8,["modelValue"])]),_:1}),t(m,{label:"原片名",prop:"original_title"},{default:r(()=>[t(d,{modelValue:i.original_title,"onUpdate:modelValue":e[12]||(e[12]=l=>i.original_title=l)},null,8,["modelValue"])]),_:1}),t(m,{label:"上映日期",prop:"release_date"},{default:r(()=>[t(oe,{modelValue:i.release_date,"onUpdate:modelValue":e[13]||(e[13]=l=>i.release_date=l),type:"date","value-format":"YYYY-MM-DD",placeholder:"选择日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),t(ue,{span:12},{default:r(()=>[t(m,{label:"电影类型",prop:"genres"},{default:r(()=>[t(X,{modelValue:i.genres,"onUpdate:modelValue":e[14]||(e[14]=l=>i.genres=l),multiple:"",placeholder:"请选择类型",style:{width:"100%"}},{default:r(()=>[(c(!0),C(O,null,E(U.value,l=>(c(),w(R,{key:l.id,label:l.genreName,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(m,{label:"IMDB ID"},{default:r(()=>[t(d,{modelValue:i.imdbId,"onUpdate:modelValue":e[15]||(e[15]=l=>i.imdbId=l)},null,8,["modelValue"])]),_:1}),t(m,{label:"TMDB ID"},{default:r(()=>[t(d,{modelValue:i.tmdbId,"onUpdate:modelValue":e[16]||(e[16]=l=>i.tmdbId=l)},null,8,["modelValue"])]),_:1}),t(m,{label:"原产国"},{default:r(()=>[t(d,{modelValue:i.origin_country,"onUpdate:modelValue":e[17]||(e[17]=l=>i.origin_country=l)},null,8,["modelValue"])]),_:1}),t(m,{label:"原始语言"},{default:r(()=>[t(d,{modelValue:i.original_language,"onUpdate:modelValue":e[18]||(e[18]=l=>i.original_language=l)},null,8,["modelValue"])]),_:1}),t(m,{label:"电影时长",prop:"runtime"},{default:r(()=>[t(ye,{modelValue:i.runtime,"onUpdate:modelValue":e[19]||(e[19]=l=>i.runtime=l),min:1,"controls-position":"right",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(m,{label:"剧情简介"},{default:r(()=>[t(d,{modelValue:i.overview,"onUpdate:modelValue":e[20]||(e[20]=l=>i.overview=l),type:"textarea",rows:4,placeholder:"请输入剧情简介"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])])}}}),Te=ae(Ee,[["__scopeId","data-v-cb7f30e0"]]);export{Te as default};
